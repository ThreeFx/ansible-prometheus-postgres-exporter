CREATE USER prometheus_postgres_exporter;
ALTER USER prometheus_postgres_exporter SET SEARCH_PATH TO prometheus_postgres_exporter,pg_catalog;

CREATE SCHEMA prometheus_postgres_exporter AUTHORIZATION prometheus_postgres_exporter;

CREATE FUNCTION prometheus_postgres_exporter.f_select_pg_stat_activity()
RETURNS setof pg_catalog.pg_stat_activity
LANGUAGE sql
SECURITY DEFINER
AS $$
  SELECT * from pg_catalog.pg_stat_activity;
$$;

CREATE FUNCTION prometheus_postgres_exporter.f_select_pg_stat_replication()
RETURNS setof pg_catalog.pg_stat_replication
LANGUAGE sql
SECURITY DEFINER
AS $$
  SELECT * from pg_catalog.pg_stat_replication;
$$;

CREATE VIEW prometheus_postgres_exporter.pg_stat_replication
AS
  SELECT * FROM prometheus_postgres_exporter.f_select_pg_stat_replication();

CREATE VIEW prometheus_postgres_exporter.pg_stat_activity
AS
  SELECT * FROM prometheus_postgres_exporter.f_select_pg_stat_activity();

GRANT SELECT ON prometheus_postgres_exporter.pg_stat_replication TO prometheus_postgres_exporter;
GRANT SELECT ON prometheus_postgres_exporter.pg_stat_activity TO prometheus_postgres_exporter;
